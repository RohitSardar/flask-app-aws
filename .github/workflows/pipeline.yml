name: Continuous Integration Continuous Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - name: Configure AWS Account
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-1

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Build Docker Image
      run: |
          docker build -t flask-web-app .

    - name: Deploy Flask App to EC2 instance
      uses: appleboy/ssh-action@v0.1.1
      with:
          host: 10.0.0.52
          username: ubuntu
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            
            # Stop and remove any existing container
            docker stop flask_web_container || true
            docker rm flask_web_container || true
            
            # Run the Flask app in a new Docker container
            docker run -d --name flask_web_container -p 5000:5000 flask-web-app:latest
            
            # Check if the container is running
            docker ps
        
